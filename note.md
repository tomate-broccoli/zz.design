# めも

## やりたいこと
  - 要件や設計のためのツールを作成する。
  - イベントストームやDDDでの利用を想定。
  - HTMLで表示てきること。
  - marmaid.jsで表示できること。
  - GITで管理できること。
  - あまり考えることなく機械的にテキパキと作業が進むこと。

## 作業手順

### ドメインイベント
  - ドメインイベントを洗い出す
  - 時系列に並び替える
  - ドメインイベントを紐付ける
    - ドメインイベントに識別子(ID)を割当てる
    - リンク先のIDを記述する(linkTo).

#### 課題など
- Q.ドメインイベントの粒度が異なる
  - 画面上の操作(例：○○ボタンを押下した)が含まれる
  - エンティティレベルの操作(例：履歴を記録した)が含まれる
  - ユースケースレベル(例：顧客情報を最新化した)が含まれる.
  - その他(例：配送完了メールを受信した)が含まれる
- A.
  - 分類できるようにタグ付けする(例: .class(command|view|action|event|...))

- Q.クエリ(例：商品を参照した)が含まれる
- A. 
  - 分類できるようにタグ付けする(例: .class(command|query|...))

- Q.ドメインイベントが多いとID付与の作業が大変になる
- A. 
  - viの置換コマンドとかで一括付与する

- Q.ドメインイベントが多いとリンク先のIDの設定が大変になる
- A. 
  - viの置換コマンドとかで一括付与する

- Q.ドメインイベントが多いと紐付け作業が大変になる
- A. 
  - viの画面分割コマンドや、検索一覧コマンドを活用する

- Q.ドメインイベントの追加などでリンク先変更時の作業が大変になる
- A. 
  - viの画面分割コマンドや、検索一覧コマンドを活用する
  - viスクリプトでマップおよび置換コマンドによる再採番などを検討する

- Q.ドメインイベントにコメント(注釈、メモ、備考、補足など)を付与したい
- A.コメント付与できるようにする(例：.note(ほげほげ)) 

### コマンド
- ドメインイベントを参考にコマンドを作成する
- 基本はドメインイベントの過去形を現在系にする(だけ)

### ポリシー
- ドメインイベントのリンク先(linkTo)のコマンドが呼び出される条件があれば記載する。

#### 課題など
- Q.時系列のため紐付けされているが、ポリシーを満たしたら呼出されるような関係ではない.
- A.
  - アクターによる判断などに依存する場合は「アクターの判断による」とでもしておく(？)
  - アクターによる判断などに依存する場合はポリシーの定義は不要とする.

- Q.ポリシーは呼出元(from)に定義すべきか？それても呼出先(to)に定義すべきか？
- A.
  - 呼出先(to)に定義する(例: .policy(ほげほげ))

### アクタ
- コマンドをアクターが実行する場合、アクターを設定する(例：.actor(顧客)).

### リードモデル(ビュー)
- アクタがコマンドを実行する判断材料となるビューを設定する(例：.view(商品データ))

### 集約
- 集約名を設定する(例：.aggregation(商品))
- 基本はコマンドの目的語(例：顧客情報)を設定する(だけ)

#### 課題など
- Q.集約ではなく「外部システム」の場合は？
- A.
  - 集約は「.aggregation()」とし、外部システムは「.outerService()」とする(例：.outerService(メールシステム))

### ここまでについて
- 以下の要素が洗い出されたはず
  - ドメインイベント: domainEvent
    - id
    - linkTo
    - note
  - コマンド: command
    - note
    - class
  - ポリシー: policy
    - note
  - アクター: actor
    - note
  - リードモデル(ビュー): view
    - note
  - 集約: aggregation
    - note
  - 外部システム: outerServcie
    - note

### 境界付けされたコンテキスト
ここからは、
- 集約中心の話になる
- データの状態に変化が想定される集約に絞る

#### 各集約をグループ化する
- １トランザクションとして扱うべき集約は同じグループになるはず
  - 同じグループになる候補は、紐付けした近くにいるはず
- ポリシ経由で紐づくものは同一グループになる可能性が高い
- アクタがコマンドを実行する場合は、その前でグループは切れるはず
- グループの先頭の集約に定義する(例：.begin())

#### 集約ルートを定義する
- グループ内に全てが同じ集約名の場合、それを集約ルートとする
- グループ内に複数の集約名が存在する場合、その中の一つを集約ルートとする
- 集約ルートに定義する(例：.root())

#### コンテキストを定義する
- 同じ集約ルートは１つのコンテキストとする(例：.context(在庫情報管理))

### ここまでについて
- イベントストーミング的なものはできたと思う。
- 以降は各コンテキスト毎のお話.

### ドメインモデル
- エンティティの洗出し
- 値オブジェクトの洗出し
- ルールの洗出し
- ロジックの洗出し

### エンティティの洗出し
- 各集約の分類でエンティティレベル(例: .class(entity))のものは、集約名がそのままエンティティとなる可能性が高い.
- そうでないものは更に掘り下げてエンティティを抽出する.

### 値オブジェクトの洗出し
- コマンドを実行した結果を満足させるために必要最低限のエンティティに紐づく項目(値オブジェクト)を洗い出す. (例: .valueObject(数量))

### ルールの洗出し
- 色々なルール(規則、制約、検査など)を洗い出す。(例： .rule(0以上の整数))
- エンティティレベル、値オブジェクトレベルのそれぞれの色々なルールを洗い出す.(例：オブジェクト生成時の初期値について、とか)
- 単項目だけでなく相関チェックに関するルールも洗い出しする.

#### 課題など
- Q.エラー時のメッセージ(文言)はどこで洗い出すのか？
- A.
  - とりあえずメモとして記録しておく？(例：.note(０以上の整数を入力してください))

- Q.値オブジェクトのルールとは？
- A.
  - データ型、長さ、有効範囲、NULL可否、初期値など

- Q.相関チェックなどの検査処理でDBアクセスして値を取得する必要がある場合は？
- A.
  - 定義(設計)段階では、対象の値オブジェクトにルールを追加する.
  - 実装においては、エンティティを汚染したくないのでドメインサービスに検査処理を定義したいが、
    ドメイン内でリポジトリ処理をしたくない...こういうのはアプリケーションサービスにさせたい.
    でもそうすると同じような処理があっちこっちに作成されることになるので、やはりドメインサービスに実装することになりそう...

### ロジックの洗出し
- コマンドを実行した結果を満足させるためのロジックを定義する.

#### 課題など
- Q.同じコンテキスト内だけど２つ以上のコマンドの組合せからなるコマンドの場合
- A.
  - ドメインサービスとして定義する.
    - 同一グループ(トランザクション)であるものとかはこれに該当する？
    - 例えば「在庫数を更新する」コマンドは、「在庫履歴を更新する」までが１トランザクションの場合、ドメインサービスにそのロジックを定義する.

- Q.エラー時のメッセージ(文言)はどこで洗い出すのか？
- A.
  - とりあえずメモとして記録しておく？(例：.note(０以上の整数を入力してください))

- Q.値を取得するための参照エンティティの扱いはどうすればいよ？
- A.
  - ドメインイベントとして洗い出して定義すべき? (例：.domeinEvent(商品マスタを参照した))
    - 分類も追加しておく? (例：.class(query))
    - テーブルを結合して取得するという手段もあるがここドメイン層はDBとは切り離された世界なのでしないものとする.

### ここまでについて
- ドメイン層的なものはできたと思う。
- 以降はアプリケーション層のお話.

### アプリケーションサービス
- ドメイン層に定義されたコマンドを組合せてユースケースを処理する
- トランザクションはここで管理する
- 例外もここで管理する
- プレゼンテーション層とのやりとりもここで処理する
- リポジトリ層とのやりとりもここで処理する

### その他について
- Q. リードモデル(ビュー)はどうするのか？
- A.
  - 別コンテキストとして同じようにエンティティ、値オブジェクトを検討していくのがよいかと.

- Q. リポジトリ層はどうするのか？
- A.
  - 洗い出されたエンティティから必要な処理(CRUD)を検討する.

- Q. プレゼンテーション層はどうするのか？
- A.
  - 洗い出されたアプリケーション層のメソッドとやりとする(だけ)

__END__